

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3Dmol.js Documentation parsers/MMTF.ts</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="../tutorials/style.css">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
             
                <a href="index.html">
                    <h1 class="navbar-item"><a href="http://3dmol.org"><b>3Dmol</b>.js</a></h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                <div class="dropdown is-hoverable is-right">
                    <a class="dropdown-trigger link">
                        Tutorials
                        <i class="fas fa-chevron-down fa-xs"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-content">
                        
                            <a class="dropdown-item" href="tutorial-code.html">
                                Using 3Dmol within your code
                            </a>
                        
                            <a class="dropdown-item" href="tutorial-embeddable.html">
                                Embedding a 3Dmol Viewer
                            </a>
                        
                            <a class="dropdown-item" href="tutorial-learning_environment.html">
                                Active Learning with 3Dmol.js
                            </a>
                        
                            <a class="dropdown-item" href="tutorial-url.html">
                                Viewing Molecules with the 3Dmol Server
                            </a>
                        
                        </div>
                    </div>
                </div>
                
                 
                    
                        <a
                            class="link user-link "
                            href="https://github.com/3dmol/3Dmol.js"
                        >
                            Github
                        </a>
                    
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Namespaces</h3><ul><li><a href="GLDraw.html">GLDraw</a></li></ul><h3>Classes</h3><ul><li><a href="$3Dmol.Label.html">Label</a></li><li><a href="$3Dmol.UI.html">UI</a></li><li><a href="Color.html">Color</a></li><li><a href="GLModel.html">GLModel</a></li><li><a href="GLShape.html">GLShape</a></li><li><a href="GLShape_GLShape.html">GLShape</a></li><li><a href="GLViewer.html">GLViewer</a></li><li><a href="GLVolumetricRender.html">GLVolumetricRender</a></li><li><a href="VolumeData.html">VolumeData</a></li></ul><h3>Classes / Gradients</h3><ul><li><a href="CustomLinear.html">CustomLinear</a></li><li><a href="ROYGB.html">ROYGB</a></li><li><a href="RWB.html">RWB</a></li><li><a href="Sinebow.html">Sinebow</a></li></ul><h3>Classes / Math</h3><ul><li><a href="Cylinder.html">Cylinder</a></li><li><a href="Matrix3.html">Matrix3</a></li><li><a href="Matrix4.html">Matrix4</a></li><li><a href="Quaternion.html">Quaternion</a></li><li><a href="Ray.html">Ray</a></li><li><a href="Sphere.html">Sphere</a></li><li><a href="Triangle.html">Triangle</a></li><li><a href="Vector2.html">Vector2</a></li><li><a href="Vector3.html">Vector3</a></li></ul><h3>Interfaces</h3><ul><li><a href="ArrowSpec.html">ArrowSpec</a></li><li><a href="AtomSelectionSpec.html">AtomSelectionSpec</a></li><li><a href="AtomSpec.html">AtomSpec</a></li><li><a href="AtomStyleSpec.html">AtomStyleSpec</a></li><li><a href="BondStyle.html">BondStyle</a></li><li><a href="BoxSpec.html">BoxSpec</a></li><li><a href="CartoonStyleSpec.html">CartoonStyleSpec</a></li><li><a href="ClickSphereStyleSpec.html">ClickSphereStyleSpec</a></li><li><a href="CrossStyleSpec.html">CrossStyleSpec</a></li><li><a href="CurveSpec.html">CurveSpec</a></li><li><a href="CustomShapeSpec.html">CustomShapeSpec</a></li><li><a href="CylinderSpec.html">CylinderSpec</a></li><li><a href="IsoSurfaceSpec.html">IsoSurfaceSpec</a></li><li><a href="LabelSpec.html">LabelSpec</a></li><li><a href="LineSpec.html">LineSpec</a></li><li><a href="LineStyleSpec.html">LineStyleSpec</a></li><li><a href="ShapeSpec.html">ShapeSpec</a></li><li><a href="SphereSpec.html">SphereSpec</a></li><li><a href="SphereStyleSpec.html">SphereStyleSpec</a></li><li><a href="StickStyleSpec.html">StickStyleSpec</a></li><li><a href="SurfaceStyleSpec.html">SurfaceStyleSpec</a></li><li><a href="UnitCellStyleSpec.html">UnitCellStyleSpec</a></li><li><a href="ViewerGridSpec.html">ViewerGridSpec</a></li><li><a href="ViewerSpec.html">ViewerSpec</a></li><li><a href="VolumetricRendererSpec.html">VolumetricRendererSpec</a></li><li><a href="WithinSelectionSpec.html">WithinSelectionSpec</a></li><li><a href="global.html#XYZ">XYZ</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CAP">CAP</a></li><li><a href="global.html#SurfaceType">SurfaceType</a></li><li><a href="global.html#bondLength">bondLength</a></li><li><a href="global.html#builtinColorSchemes">builtinColorSchemes</a></li><li><a href="global.html#conversionMatrix3">conversionMatrix3</a></li><li><a href="global.html#createViewer">createViewer</a></li><li><a href="global.html#createViewerGrid">createViewerGrid</a></li><li><a href="global.html#download">download</a></li><li><a href="global.html#elementColors">elementColors</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getbin">getbin</a></li><li><a href="global.html#setBondLength">setBondLength</a></li><li><a href="global.html#ssColors">ssColors</a></li><li><a href="global.html#syncSurface">syncSurface</a></li><li><a href="global.html#viewers">viewers</a></li></ul></div><div class="category"><h2>Parsers</h2><h3>Interfaces</h3><ul><li><a href="ParserOptionsSpec.html">ParserOptionsSpec</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CDJSON">CDJSON</a></li><li><a href="global.html#CIF">CIF</a></li><li><a href="global.html#CUBE">CUBE</a></li><li><a href="global.html#GRO">GRO</a></li><li><a href="global.html#LAMMPSTRJ">LAMMPSTRJ</a></li><li><a href="global.html#MMTFparser">MMTFparser</a></li><li><a href="global.html#MOL2">MOL2</a></li><li><a href="global.html#PDB">PDB</a></li><li><a href="global.html#PQR">PQR</a></li><li><a href="global.html#PRMTOP">PRMTOP</a></li><li><a href="global.html#SDF">SDF</a></li><li><a href="global.html#VASP">VASP</a></li><li><a href="global.html#XYZ">XYZ</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>parsers/MMTF.ts</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { base64ToArray } from "../utilities";
import { Matrix4 } from "../WebGL";
import { computeSecondaryStructure } from "./utils/computeSecondaryStructure";
import { processSymmetries } from "./utils/processSymmetries";

interface MMTFobj {
    decode(data: Uint8Array | ArrayBuffer): any;
}
declare var MMTF: MMTFobj;

var fromCharCode = function (charCodeArray) {
    return String.fromCharCode.apply(null, charCodeArray).replace(/\0/g, '');
};

var convertSS = function (val) {
    //convert mmtf code to 3dmol code
    /*    
      0:  pi helix
      1:  bend
      2:  alpha helix
      3:  sheet extended
      4:  3-10 helix
      5:  bridge
      6:  turn
      7:  coil
     */
    if (val == 0 || val == 2 || val == 4) return 'h';
    if (val == 3) return 's';
    return 'c';
};

let mmtfHETATMtypes = new Set([
    "D-SACCHARIDE",
    "D-SACCHARIDE 1,4 AND 1,4 LINKING",
    "D-SACCHARIDE 1,4 AND 1,6 LINKING",
    "L-SACCHARIDE",
    "L-SACCHARIDE 1,4 AND 1,4 LINKING",
    "L-SACCHARIDE 1,4 AND 1,6 LINKING",
    "NON-POLYMER",
    "OTHER",
    "PEPTIDE-LIKE",
    "SACCHARIDE"]);

/** @param bindata - binary UInt8Array buffer or a base64 encoded string
 *  @param ParserOptionsSpec
 *  @category Parsers
*/
export function MMTFparser(bindata, options) {

    var noH = !options.keepH; // suppress hydrogens by default
    var selAltLoc = options.altLoc ? options.altLoc : 'A'; //default alternate location to select if present
    var ignoreStruct = !!options.noSecondaryStructure;
    var computeStruct = !options.noComputeSecondaryStructure;
    //extract symmetries - only take first assembly, apply to all models (ignoring changes for now)
    var noAssembly = !options.doAssembly; // don't assemble by default
    var assemblyIndex = options.assemblyIndex ? options.assemblyIndex : 0;

    if (typeof (bindata) == "string") {
        //assume base64 encoded
        bindata = base64ToArray(bindata);
    } else {
        bindata = new Uint8Array(bindata);
    }

    var mmtfData = MMTF.decode(bindata);

    var atoms: any[][] &amp; Record&lt;string, any> = [[]];
    var modelData: any[] = atoms.modelData = [];

    // setup index counters
    var modelIndex = 0;
    var chainIndex = 0;
    var groupIndex = 0;
    var atomIndex = 0;

    // setup optional fields
    var secStructList = mmtfData.secStructList;
    var insCodeList = mmtfData.insCodeList;
    var sequenceIndexList = mmtfData.sequenceIndexList;
    var bFactorList = mmtfData.bFactorList;
    var altLocList = mmtfData.altLocList;
    var occupancyList = mmtfData.occupancyList;
    var bondAtomList = mmtfData.bondAtomList;
    var bondOrderList = mmtfData.bondOrderList;

    var numModels = mmtfData.numModels;
    if (numModels == 0) return atoms;
    if (!options.multimodel) numModels = 1; //first only
    // hoisted loop variables
    var i, j, k, kl, m, n;



    var symmetries: Matrix4[] = [];
    if (!noAssembly &amp;&amp; mmtfData.bioAssemblyList &amp;&amp; mmtfData.bioAssemblyList.length > 0) {
        var transforms = mmtfData.bioAssemblyList[assemblyIndex].transformList;
        for (i = 0, n = transforms.length; i &lt; n; i++) {
            var matrix = new Matrix4(transforms[i].matrix);
            matrix.transpose();
            symmetries.push(matrix);
        }
    }
    var unitCell = null as Record&lt;string, number> | null;
    //unit cell info
    if (mmtfData.unitCell) {
        var u = mmtfData.unitCell;
        unitCell = { 'a': u[0], 'b': u[1], 'c': u[2], 'alpha': u[3], 'beta': u[4], 'gamma': u[5] };
    }

    let chainIsPolymer: boolean[] = [];
    mmtfData.entityList.forEach(entity => {
        entity.chainIndexList.forEach(ch => {
            chainIsPolymer[ch] = entity.type == "polymer";
        });
    });
    var bondAtomListStart = 0; //for current model
    //loop over models, 
    for (m = 0; m &lt; numModels; m++) {
        var modelChainCount = mmtfData.chainsPerModel[m];
        var matoms = atoms[atoms.length - 1];
        var serialToIndex: number[] = []; // map to matoms index, needed for noh

        modelData.push({ symmetries: symmetries, cryst: unitCell });
        for (i = 0; i &lt; modelChainCount; ++i) {

            var chainGroupCount = mmtfData.groupsPerChain[chainIndex];
            var chainId = fromCharCode(
                mmtfData.chainIdList.subarray(chainIndex * 4, chainIndex * 4 + 4)
            );
            if (mmtfData.chainNameList) {
                chainId = fromCharCode(
                    mmtfData.chainNameList.subarray(chainIndex * 4, chainIndex * 4 + 4)
                );
            }

            var startGroup = groupIndex;
            var prevSS = '';
            for (j = 0; j &lt; chainGroupCount; ++j) { //over residues (groups)

                var groupData = mmtfData.groupList[mmtfData.groupTypeList[groupIndex]];
                var groupAtomCount = groupData.atomNameList.length;
                var secStruct = 0;
                var secStructBegin = false;
                var secStructEnd = false;

                if (secStructList) {
                    secStruct = secStructList[groupIndex];
                    var sscode = convertSS(secStruct);
                    if (groupIndex == 0 || sscode != prevSS) {
                        secStructBegin = true;
                    }
                    prevSS = sscode;
                    var nextgroup = groupIndex + 1;
                    if (nextgroup >= secStructList.length || convertSS(secStructList[nextgroup] != sscode)) {
                        secStructEnd = true;
                    }
                }
                var insCode = null as string | null;
                if (mmtfData.insCodeList) {
                    insCode = String.fromCharCode(insCodeList[groupIndex]);
                }
                var sequenceIndex = null;
                if (sequenceIndexList) {
                    sequenceIndex = sequenceIndexList[groupIndex];
                }

                var groupId = mmtfData.groupIdList[groupIndex];
                var groupName = groupData.groupName;
                let groupType = groupData.chemCompType;
                var startAtom = atomIndex;
                //note the following is not identical to respecting HETATM records
                //this information isn't available in MMTF.  
                let isHETATM = mmtfHETATMtypes.has(groupType) || !chainIsPolymer[chainIndex];

                for (k = 0; k &lt; groupAtomCount; ++k) {

                    var element = groupData.elementList[k];
                    if (noH &amp;&amp; element == 'H') {
                        atomIndex += 1;
                        continue;
                    }

                    var bFactor = '';
                    if (bFactorList) {
                        bFactor = bFactorList[atomIndex];
                    }
                    var altLoc = '';
                    if (altLocList &amp;&amp; altLocList[atomIndex]) { //not zero
                        altLoc = String.fromCharCode(altLocList[atomIndex]);
                    }
                    var occupancy = '';
                    if (occupancyList) {
                        occupancy = occupancyList[atomIndex];
                    }

                    if (altLoc != '' &amp;&amp; altLoc != selAltLoc &amp;&amp; selAltLoc != '*') {
                        atomIndex += 1;
                        continue;
                    }

                    var atomId = mmtfData.atomIdList[atomIndex];
                    var atomName = groupData.atomNameList[k];
                    var atomCharge = 0;
                    if (groupData.atomChargeList) atomCharge = groupData.atomChargeList[k];
                    var xCoord = mmtfData.xCoordList[atomIndex];
                    var yCoord = mmtfData.yCoordList[atomIndex];
                    var zCoord = mmtfData.zCoordList[atomIndex];

                    serialToIndex[atomIndex] = matoms.length;
                    matoms.push({
                        'resn': groupName,
                        'x': xCoord,
                        'y': yCoord,
                        'z': zCoord,
                        'elem': element,
                        'hetflag': isHETATM,
                        'chain': chainId,
                        'resi': groupId,
                        'icode': altLoc,
                        'rescode': groupId + (altLoc != ' ' ? "^" + altLoc : ""), // combo
                        // resi
                        // and
                        // icode
                        'serial': atomId,
                        'altLoc': altLoc,
                        'index': atomIndex,
                        'atom': atomName,
                        'bonds': [],
                        'ss': convertSS(secStruct),
                        'ssbegin': secStructBegin,
                        'ssend': secStructEnd,
                        'bondOrder': [],
                        'properties': { charge: atomCharge, occupancy: occupancy },
                        'b': bFactor,
                    });

                    atomIndex += 1;
                }

                // intra group bonds
                var groupBondAtomList = groupData.bondAtomList;
                for (k = 0, kl = groupData.bondOrderList.length; k &lt; kl; ++k) {
                    var atomIndex1 = startAtom + groupBondAtomList[k * 2];
                    var atomIndex2 = startAtom + groupBondAtomList[k * 2 + 1];
                    var bondOrder = groupData.bondOrderList[k];

                    //I assume bonds are only recorded once
                    var i1 = serialToIndex[atomIndex1];
                    var i2 = serialToIndex[atomIndex2];
                    var a1 = matoms[i1];
                    var a2 = matoms[i2];
                    if (a1 &amp;&amp; a2) {
                        a1.bonds.push(i2);
                        a1.bondOrder.push(bondOrder);
                        a2.bonds.push(i1);
                        a2.bondOrder.push(bondOrder);
                    }
                }

                groupIndex += 1;
            }

            //reset for bonds
            groupIndex = startGroup;
            for (j = 0; j &lt; chainGroupCount; ++j) { //over residues (groups)

                groupIndex += 1;

            }

            chainIndex += 1;
        }


        // inter group bonds
        if (bondAtomList) {
            for (let k = bondAtomListStart, kl = bondAtomList.length; k &lt; kl; k += 2) {
                let atomIndex1 = bondAtomList[k];
                let atomIndex2 = bondAtomList[k + 1];
                let bondOrder = bondOrderList ? bondOrderList[k / 2] : 1;

                if (atomIndex1 >= atomIndex) {
                    bondAtomListStart = k;
                    break; //on next model
                }
                //I assume bonds are only recorded once
                let i1 = serialToIndex[atomIndex1];
                let i2 = serialToIndex[atomIndex2];
                let a1 = matoms[i1];
                let a2 = matoms[i2];
                if (a1 &amp;&amp; a2) {
                    a1.bonds.push(i2);
                    a1.bondOrder.push(bondOrder);
                    a2.bonds.push(i1);
                    a2.bondOrder.push(bondOrder);
                }
            }
        }

        if (options.multimodel) {
            if (!options.onemol) atoms.push([]);
        }

        modelIndex += 1;
    }

    if (!noAssembly) {
        for (let n = 0; n &lt; atoms.length; n++) {
            processSymmetries(modelData[n].symmetries, atoms[n], options, modelData[n].cryst);
        }
    }

    if (computeStruct &amp;&amp; !ignoreStruct) {
        computeSecondaryStructure(atoms, options.hbondCutoff);
    }

    return atoms;
};</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>hljs.highlightAll();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
